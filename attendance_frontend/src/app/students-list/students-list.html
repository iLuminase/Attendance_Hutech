<div class="students-container">
  <!-- Header với actions -->
  <mat-toolbar class="page-toolbar">
    <span class="page-title">
      <mat-icon>groups</mat-icon>
      Quản lý sinh viên
    </span>

    <div class="toolbar-spacer"></div>

    <div class="toolbar-actions">
      <button
        mat-raised-button
        color="primary"
        (click)="openCreateDialog()"
        [disabled]="isCreating"
      >
        <mat-icon>add</mat-icon>
        Thêm sinh viên
      </button>

      <button mat-stroked-button (click)="exportStudents()" [disabled]="isLoading">
        <mat-icon>file_download</mat-icon>
        Xuất Excel
      </button>

      <button mat-stroked-button color="warn" (click)="testApiData()" [disabled]="isLoading">
        <mat-icon>bug_report</mat-icon>
        Debug
      </button>
    </div>
  </mat-toolbar>

  <!-- Filter và Search -->
  <mat-card class="filter-card">
    <mat-card-content>
      <form [formGroup]="searchForm" class="filter-form">
        <div class="filter-row">
          <mat-form-field appearance="outline" class="search-field">
            <mat-label>Tìm kiếm</mat-label>
            <input matInput formControlName="search" placeholder="Tìm theo tên, mã SV, email..." />
            <mat-icon matSuffix>search</mat-icon>
          </mat-form-field>

          <mat-form-field appearance="outline" class="filter-field">
            <mat-label>Lớp</mat-label>
            <mat-select
              formControlName="class_id"
              (selectionChange)="onFilterChange('class_id', $event.value)"
            >
              <mat-option value="">Tất cả</mat-option>
              <mat-option *ngFor="let c of classes" [value]="c.class_id">
                {{ c.class_name || c.class_id }}
              </mat-option>
            </mat-select>
            <mat-icon matSuffix>class</mat-icon>
          </mat-form-field>
        </div>
      </form>
    </mat-card-content>
  </mat-card>

  <!-- Statistics cards -->
  <div class="stats-row">
    <mat-card class="stat-card">
      <mat-card-content class="stat-content">
        <div class="stat-info">
          <div class="stat-number">{{ totalStudents }}</div>
          <div class="stat-label">Tổng sinh viên</div>
        </div>
        <mat-icon class="stat-icon">groups</mat-icon>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card active">
      <mat-card-content class="stat-content">
        <div class="stat-info">
          <div class="stat-number">{{ filteredStudents.length }}</div>
          <div class="stat-label">Đang hiển thị</div>
        </div>
        <mat-icon class="stat-icon">filter_list</mat-icon>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Table -->
  <mat-card class="table-card">
    <div class="table-container">
      <!-- Loading spinner -->
      <div *ngIf="isLoading" class="loading-container">
        <mat-spinner></mat-spinner>
        <p>Đang tải dữ liệu...</p>
      </div>

      <!-- Data table -->
      <table mat-table [dataSource]="dataSource" matSort class="students-table" *ngIf="!isLoading">
        <!-- Avatar Column -->
        <ng-container matColumnDef="avatar">
          <th mat-header-cell *matHeaderCellDef>Ảnh</th>
          <td mat-cell *matCellDef="let student">
            <div class="student-avatar">
              <mat-icon class="default-avatar">account_circle</mat-icon>
            </div>
          </td>
        </ng-container>

        <!-- Student ID Column -->
        <ng-container matColumnDef="student_id">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Mã SV</th>
          <td mat-cell *matCellDef="let student">
            <div class="student-code">{{ student.student_id }}</div>
          </td>
        </ng-container>

        <!-- Name Column -->
        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Họ và tên</th>
          <td mat-cell *matCellDef="let student">
            <div class="student-info">
              <div class="student-name">{{ student.name }}</div>
              <div class="student-email">{{ student.email }}</div>
            </div>
          </td>
        </ng-container>

        <!-- Email Column -->
        <ng-container matColumnDef="email">
          <th mat-header-cell *matHeaderCellDef>Email</th>
          <td mat-cell *matCellDef="let student">{{ student.email }}</td>
        </ng-container>

        <!-- Phone Column -->
        <ng-container matColumnDef="phone">
          <th mat-header-cell *matHeaderCellDef>Điện thoại</th>
          <td mat-cell *matCellDef="let student">{{ student.phone }}</td>
        </ng-container>

        <!-- Class ID Column -->
        <ng-container matColumnDef="class_id">
          <th mat-header-cell *matHeaderCellDef>Lớp</th>
          <td mat-cell *matCellDef="let student">
            <mat-chip-listbox>
              <mat-chip-option selected>{{ getClassName(student.class_id) }}</mat-chip-option>
            </mat-chip-listbox>
          </td>
        </ng-container>

        <!-- Status column removed - not in backend model -->

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Thao tác</th>
          <td mat-cell *matCellDef="let student">
            <div class="action-buttons">
              <button
                mat-icon-button
                color="primary"
                (click)="openEditDialog(student)"
                [disabled]="isUpdating"
                matTooltip="Sửa thông tin"
              >
                <mat-icon>edit</mat-icon>
              </button>

              <button
                mat-icon-button
                color="warn"
                (click)="deleteStudent(student)"
                [disabled]="isDeleting"
                matTooltip="Xóa sinh viên"
              >
                <mat-icon>delete</mat-icon>
              </button>

              <button mat-icon-button [matMenuTriggerFor]="actionMenu" matTooltip="Thêm">
                <mat-icon>more_vert</mat-icon>
              </button>

              <mat-menu #actionMenu="matMenu">
                <button mat-menu-item (click)="viewStudentDetail(student)">
                  <mat-icon>visibility</mat-icon>
                  <span>Xem chi tiết</span>
                </button>
                <button mat-menu-item>
                  <mat-icon>assignment</mat-icon>
                  <span>Lịch sử điểm danh</span>
                </button>
              </mat-menu>
            </div>
          </td>
        </ng-container>

        <!-- Select Column (for bulk actions) - to be implemented later -->

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns" class="student-row"></tr>
      </table>

      <!-- No data message -->
      <div *ngIf="!isLoading && dataSource.data.length === 0" class="no-data">
        <mat-icon>groups</mat-icon>
        <h3>Không có sinh viên nào</h3>
        <p>Hãy thêm sinh viên mới để bắt đầu</p>
        <button mat-raised-button color="primary" (click)="openCreateDialog()">
          <mat-icon>add</mat-icon>
          Thêm sinh viên đầu tiên
        </button>
      </div>
    </div>

    <!-- Pagination sẽ được thêm sau -->
  </mat-card>
</div>
